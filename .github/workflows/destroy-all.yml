name: ğŸ”¥ Destroy All Infrastructure

on:
  workflow_dispatch:
    inputs:
      confirm_destroy:
        description: 'Type "DESTROY" to confirm destruction of ALL environments'
        required: true
        type: string
      environments:
        description: 'Environments to destroy'
        required: true
        default: 'dev,stage,prod'
        type: choice
        options:
          - 'dev'
          - 'stage' 
          - 'prod'
          - 'dev,stage'
          - 'stage,prod'
          - 'dev,stage,prod'

permissions:
  id-token: write
  contents: read

jobs:
  confirm-destroy:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm_destroy == 'DESTROY'
    steps:
      - name: âš ï¸ Destruction Confirmation
        run: |
          echo "ğŸ”¥ DESTROYING INFRASTRUCTURE IN: ${{ github.event.inputs.environments }}"
          echo "âš ï¸  This action is IRREVERSIBLE!"
          echo "ğŸ“‹ Environments selected: ${{ github.event.inputs.environments }}"

  destroy-dev:
    needs: confirm-destroy
    if: contains(github.event.inputs.environments, 'dev')
    runs-on: ubuntu-latest
    environment: development
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: ğŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-2

      - name: ğŸ”¥ Destroy Dev Environment
        working-directory: environments/dev
        run: |
          terraform init
          terraform destroy -var-file="terraform-dev.tfvars" -auto-approve
          echo "âœ… Dev environment destroyed"

  destroy-stage:
    needs: confirm-destroy
    if: contains(github.event.inputs.environments, 'stage')
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: ğŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-2

      - name: ğŸ”¥ Destroy Stage Environment
        working-directory: environments/stage
        run: |
          terraform init
          terraform destroy -var-file="terraform-stage.tfvars" -auto-approve
          echo "âœ… Stage environment destroyed"

  destroy-prod:
    needs: confirm-destroy
    if: contains(github.event.inputs.environments, 'prod')
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: ğŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-2

      - name: ğŸ”¥ Destroy Prod Environment
        working-directory: environments/prod
        run: |
          terraform init
          terraform destroy -var-file="terraform-prod.tfvars" -auto-approve
          echo "âœ… Prod environment destroyed"

  cleanup-summary:
    needs: [destroy-dev, destroy-stage, destroy-prod]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“Š Destruction Summary
        run: |
          echo "ğŸ”¥ INFRASTRUCTURE DESTRUCTION COMPLETE"
          echo "ğŸ“‹ Requested environments: ${{ github.event.inputs.environments }}"
          echo "âœ… Dev: ${{ needs.destroy-dev.result }}"
          echo "âœ… Stage: ${{ needs.destroy-stage.result }}"  
          echo "âœ… Prod: ${{ needs.destroy-prod.result }}"
          echo ""
          echo "âš ï¸  Note: Backend resources (S3, DynamoDB) are preserved"
          echo "ğŸ”§ To destroy backend: Run destroy-backend workflow separately"
