name: Quick Diagnostic

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  diagnose:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: us-east-2

    - name: Check AWS Connection
      run: |
        echo "ğŸ” Testing AWS connection..."
        aws sts get-caller-identity
        echo "âœ… AWS connection works"

    - name: Check S3 Bucket
      run: |
        echo "ğŸ” Checking S3 bucket..."
        aws s3 ls s3://terraform-state-vpc-project-7bc0e5bf || echo "âŒ Bucket not accessible"
        echo "âœ… S3 check complete"

    - name: Check DynamoDB Table
      run: |
        echo "ğŸ” Checking DynamoDB table..."
        aws dynamodb describe-table --table-name terraform-locks --region us-east-2 || echo "âŒ Table not accessible"
        echo "âœ… DynamoDB check complete"

    - name: Test Terraform Init (Dev)
      run: |
        echo "ğŸ” Testing terraform init in dev..."
        cd environments/dev
        terraform init || echo "âŒ Terraform init failed"
