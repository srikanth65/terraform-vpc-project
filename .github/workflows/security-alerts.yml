name: Security Vulnerability Alerts

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:
  push:
    branches: [main, develop]
    paths: ['**/*.tf', '**/*.yml', '**/*.yaml']

permissions:
  security-events: write
  contents: read

jobs:
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Run Checkov
      id: checkov
      run: |
        pip install checkov
        checkov -d . --framework terraform --config-file .checkov.yml --output json --output-file checkov-results.json || true
        # Ensure JSON file exists
        if [ ! -f "checkov-results.json" ]; then
          echo '{"summary": {"failed": 0, "passed": 0}}' > checkov-results.json
        fi

    - name: Run TFSec
      id: tfsec
      run: |
        curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash
        sudo mv tfsec /usr/local/bin/
        tfsec . --format json --out tfsec-results.json || true
        # Ensure JSON file exists
        if [ ! -f "tfsec-results.json" ]; then
          echo '{"results": []}' > tfsec-results.json
        fi

    - name: Parse Security Results
      id: parse
      run: |
        # Parse Checkov results
        CHECKOV_FAILED=$(jq '.summary.failed // 0' checkov-results.json 2>/dev/null || echo "0")
        CHECKOV_PASSED=$(jq '.summary.passed // 0' checkov-results.json 2>/dev/null || echo "0")
        
        # Parse TFSec results
        TFSEC_FAILED=$(jq '.results | length' tfsec-results.json 2>/dev/null || echo "0")
        
        echo "checkov_failed=$CHECKOV_FAILED" >> $GITHUB_OUTPUT
        echo "checkov_passed=$CHECKOV_PASSED" >> $GITHUB_OUTPUT
        echo "tfsec_failed=$TFSEC_FAILED" >> $GITHUB_OUTPUT
        
        # Create summary
        TOTAL_ISSUES=$((CHECKOV_FAILED + TFSEC_FAILED))
        echo "total_issues=$TOTAL_ISSUES" >> $GITHUB_OUTPUT
        
        if [ $TOTAL_ISSUES -gt 0 ]; then
          echo "has_vulnerabilities=true" >> $GITHUB_OUTPUT
        else
          echo "has_vulnerabilities=false" >> $GITHUB_OUTPUT
        fi

    - name: Slack Alert - High Severity
      if: steps.parse.outputs.has_vulnerabilities == 'true' && secrets.SLACK_SECURITY_WEBHOOK_URL != ''
      run: |
        curl -X POST -H 'Content-type: application/json' \
          --data '{
            "text": "üö® SECURITY VULNERABILITIES DETECTED",
            "attachments": [{
              "color": "danger",
              "fields": [
                {"title": "Repository", "value": "${{ github.repository }}", "short": true},
                {"title": "Branch", "value": "${{ github.ref_name }}", "short": true},
                {"title": "Checkov Issues", "value": "${{ steps.parse.outputs.checkov_failed }}", "short": true},
                {"title": "TFSec Issues", "value": "${{ steps.parse.outputs.tfsec_failed }}", "short": true},
                {"title": "Total Issues", "value": "${{ steps.parse.outputs.total_issues }}", "short": true},
                {"title": "View Details", "value": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}", "short": false}
              ]
            }]
          }' \
          ${{ secrets.SLACK_SECURITY_WEBHOOK_URL }}

    - name: Teams Alert - High Severity
      if: steps.parse.outputs.has_vulnerabilities == 'true'
      uses: skitionek/notify-microsoft-teams@master
      with:
        webhook_url: ${{ secrets.TEAMS_WEBHOOK_URL }}
        overwrite: |
          {
            "@type": "MessageCard",
            "@context": "https://schema.org/extensions",
            "summary": "Security Vulnerabilities Detected",
            "themeColor": "ff6b6b",
            "sections": [{
              "activityTitle": "üö® Security Vulnerabilities Detected",
              "activitySubtitle": "Infrastructure Security Scan",
              "activityImage": "https://cdn-icons-png.flaticon.com/512/1828/1828506.png",
              "facts": [{
                "name": "Repository:",
                "value": "${{ github.repository }}"
              }, {
                "name": "Branch:",
                "value": "${{ github.ref_name }}"
              }, {
                "name": "Checkov Issues:",
                "value": "${{ steps.parse.outputs.checkov_failed }} failed"
              }, {
                "name": "TFSec Issues:",
                "value": "${{ steps.parse.outputs.tfsec_failed }} found"
              }, {
                "name": "Total Issues:",
                "value": "${{ steps.parse.outputs.total_issues }}"
              }],
              "markdown": true
            }],
            "potentialAction": [{
              "@type": "OpenUri",
              "name": "View Security Report",
              "targets": [{
                "os": "default",
                "uri": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              }]
            }]
          }

    - name: Slack Alert - All Clear
      if: steps.parse.outputs.has_vulnerabilities == 'false' && github.event_name == 'workflow_dispatch'
      uses: 8398a7/action-slack@v3
      with:
        status: success
        webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        channel: '#security-alerts'
        username: 'Security Bot'
        icon_emoji: ':shield:'
        text: |
          ‚úÖ **Security Scan Complete - All Clear!**
          
          üìä **Scan Results:**
          ‚Ä¢ Checkov: ${{ steps.parse.outputs.checkov_passed }} checks passed
          ‚Ä¢ TFSec: No issues found
          
          üìã **Repository:** ${{ github.repository }}
          üåø **Branch:** ${{ github.ref_name }}
          
          üõ°Ô∏è **Status:** No security vulnerabilities detected

    - name: Upload Security Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-scan-results-${{ github.run_number }}
        path: |
          checkov-results.json
          tfsec-results.json
        retention-days: 30
